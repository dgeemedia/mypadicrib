<!--views/owner/dashboard.ejs-->
<section>
  <h1>Owner Dashboard</h1>

  <p>Welcome, <%= user ? user.name : 'Owner' %>. Manage your listings below.</p>

  <% if (listings && listings.length) { %>
    
    <section>
  <h2>Inbox</h2>
  <% if (conversations && conversations.length) { %>
    <ul>
      <% conversations.forEach(function(c){ %>
        <li>
          <a href="/messages/<%= c.id %>"><strong><%= c.subject || ('Conversation #' + c.id) %></strong></a>
          <% if (c.lastMessage) { %>
            <div><small><%= c.lastMessage.sender_name %> — <%= c.lastMessage.body.length > 120 ? c.lastMessage.body.slice(0,120) + '…' : c.lastMessage.body %></small></div>
          <% } %>
          <small>Updated: <%= new Date(c.last_message_at).toLocaleString() %></small>
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <p>No messages yet.</p>
  <% } %>
</section>
    
    <section>
      <h2>Your Listings</h2>
      <ul class="owner-listings" style="list-style:none; padding:0;">
        <% listings.forEach(function(l) { %>
          <li style="border:1px solid #ddd; padding:12px; margin-bottom:12px;">
            <h3><a href="/listings/<%= l.id %>"><%= l.title %></a></h3>
            <p><%= l.description %></p>
            <p><strong>Price (per night):</strong> &#8358;<%= l.price %></p>

            <!-- Status block with paid_until and renew/pay links -->
            <p>
              <strong>Status:</strong>
              <% if (l.status === 'pending') { %>
                <span>Pending verification</span>
              <% } else if (l.status === 'approved' && l.is_active) { %>
                <span>Approved — active</span>
                <% if (l.paid_until) { %>
                  <small> (paid until <%= new Date(l.paid_until).toLocaleString() %>)</small>
                  <% if (new Date(l.paid_until) <= new Date()) { %>
                    <span style="color:crimson"> — expired</span>
                  <% } %>
                <% } %>
              <% } else if (l.status === 'payment_required') { %>
                <span>Payment required — <a href="/payments/listing-fee?listingId=<%= l.id %>">Pay now</a></span>
              <% } else if (!l.is_active || l.status === 'suspended') { %>
                <span>Suspended / Inactive — <a href="/payments/listing-fee?listingId=<%= l.id %>">Renew</a></span>
              <% } else if (l.status === 'deleted') { %>
                <span>Deleted (soft)</span>
              <% } else { %>
                <span><%= l.status %></span>
              <% } %>
            </p>

            <!-- Listing fee summary -->
            <p>
              <strong>Listing fee:</strong>
              <% if (l.listing_fee_amount && !l.listing_fee_paid) { %>
                <span>₦<%= l.listing_fee_amount %> (unpaid)</span>
                <a href="/payments/listing-fee?listingId=<%= l.id %>">Pay listing fee</a>
              <% } else if (l.listing_fee_amount) { %>
                <span>₦<%= l.listing_fee_amount %> (paid)</span>
              <% } else { %>
                <span>Free</span>
              <% } %>
            </p>

            <!-- Renew form (owner only) -->
            <% if (user && user.id === l.owner_id) { %>
              <form method="GET" action="/payments/listing-fee" style="display:inline; margin-bottom:10px;">
                <input type="hidden" name="listingId" value="<%= l.id %>">
                <label style="margin-right:6px;">
                  <select name="period">
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                  </select>
                </label>
                <button type="submit">Renew</button>
              </form>
            <% } %>

            <section>
              <h4>Images</h4>
              <% if (l.image_path || l.images && l.images.length) { %>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <% if (l.images && l.images.length) { %>
                    <% l.images.forEach(function(img) { %>
                      <div style="border:1px solid #ccc; padding:6px;">
                        <img src="<%= img.image_path %>" alt="img" width="140" style="display:block; margin-bottom:6px;">
                        <form method="POST" action="/listings/<%= l.id %>/images/<%= img.id %>/delete">
                          <button type="submit" onclick="return confirm('Delete image?')">Delete</button>
                        </form>
                      </div>
                    <% }) %>
                  <% } else if (l.image_path) { %>
                    <img src="<%= l.image_path %>" width="160" alt="listing image">
                  <% } %>
                </div>
              <% } else { %>
                <p>No images yet.</p>
              <% } %>

              <form method="POST" action="/listings/<%= l.id %>/images" enctype="multipart/form-data" style="margin-top:8px;">
                <label>Upload images (up to 6)<br>
                  <input type="file" name="images" accept="image/*" multiple>
                </label><br>
                <button type="submit">Upload</button>
              </form>
            </section>

            <p style="margin-top:8px">
              <a href="/listings/<%= l.id %>">View public listing</a>
            </p>
          </li>
        <% }) %>
      </ul>
    </section>
  <% } else { %>
    <p>You have no listings yet. <a href="/listings/new">Create your first listing</a>.</p>
  <% } %>

  <hr>

  <section>
    <h2>Create a new listing</h2>
    <p><a href="/listings/new">Go to the create listing form</a></p>
  </section>

  <hr>

  <section>
    <h2>Owner Quick Links</h2>
    <ul>
      <li><a href="/owner/dashboard">Refresh</a></li>
      <li><a href="/listings/new">Create listing</a></li>
      <li><a href="/listings">Browse approved listings</a></li>
    </ul>
  </section>
</section>
