<!-- views/listings/detail.ejs -->
<section class="container listing-detail">
  <article class="card" style="align-items:flex-start;">
    <div class="gallery-area" style="width:360px;">
      <% if (images && images.length) { %>
        <div class="gallery-main-wrap" style="position:relative;">
          <img id="gallery-main" src="<%= images[0].image_path %>" alt="primary" style="width:100%;height:260px;object-fit:cover;border-radius:8px;cursor:zoom-in">
        </div>
      <% } else { %>
        <div style="width:100%;height:260px;background:#efefef;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#888">No Image</div>
      <% } %>

      <% if (images && images.length > 1) { %>
        <div class="gallery-thumbs" id="gallery-thumbs" style="display:flex;gap:8px;overflow-x:auto;padding-top:8px;margin-top:8px;">
          <% images.forEach(function(img, idx){ %>
            <div class="thumb-item" data-src="<%= img.image_path %>" data-index="<%= idx %>" tabindex="0" style="flex:0 0 auto;border-radius:6px;overflow:hidden;border:2px solid transparent;cursor:pointer;">
              <img src="<%= img.image_path %>" alt="thumb-<%= idx %>" style="width:120px;height:80px;object-fit:cover;display:block;">
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>

    <div style="flex:1; margin-left:16px;">
      <h2><%= listing.title %></h2>
      <p style="color:var(--muted)"><%= listing.description %></p>
      <p><strong>Address:</strong> <%= listing.address || '' %> — <%= listing.state || '' %>, <%= listing.lga || '' %></p>
      <p class="price">₦<%= listing.price %> / night</p>

      <% if (user) { %>
        <% if (user.id !== listing.owner_id) { %>
          <form method="GET" action="/payments/checkout">
            <input type="hidden" name="listingId" value="<%= listing.id %>">
            <button type="submit">Book / Checkout</button>
          </form>
        <% } else { %>
          <p style="color:#777;">This is your listing.</p>
        <% } %>
      <% } else { %>
        <p><a href="/auth/login">Login</a> to book this listing</p>
      <% } %>
    </div>
  </article>

  <!-- Reviews section (unchanged) -->
  <section class="reviews" style="margin-top:20px;">
    <h3>Reviews</h3>
    <!-- (your existing review markup here) -->
    <button type="button" class="view-comments-btn" data-listing-id="<%= listing.id %>" data-listing-title="<%= listing.title %>">Open comments</button>
    <% if (user) { %>
      <form class="review-form" method="POST" action="/reviews">
        <input type="hidden" name="listing_id" value="<%= listing.id %>">
        <label>Rating
          <select name="rating" required>
            <option value="5">5 - Excellent</option>
            <option value="4">4 - Good</option>
            <option value="3">3 - Okay</option>
            <option value="2">2 - Poor</option>
            <option value="1">1 - Terrible</option>
          </select>
        </label>
        <label>Comment
          <textarea name="comment" rows="3" required></textarea>
        </label>
        <button type="submit">Post Review</button>
      </form>
    <% } else { %>
      <p><a href="/auth/login">Sign in</a> to leave a review</p>
    <% } %>

    <% if (reviews && reviews.length) { %>
      <% reviews.forEach(function(r){ %>
        <div class="review">
          <p><strong><%= r.name %></strong> • <small><%= new Date(r.created_at).toLocaleString() %></small></p>
          <p aria-hidden="true">
            <% for (let i=1;i<=5;i++) { %>
              <% if (i <= r.rating) { %>
                <span class="star filled">★</span>
              <% } else { %>
                <span class="star">☆</span>
              <% } %>
            <% } %>
            <small style="color:var(--muted)"> — <%= r.rating %>/5</small>
          </p>
          <p><%= r.comment %></p>
          <% if (r.replies && r.replies.length) { %>
            <% r.replies.forEach(function(rep){ %>
              <div class="reply">
                <p><strong><%= rep.name %></strong> • <small><%= new Date(rep.created_at).toLocaleString() %></small></p>
                <p><%= rep.comment %></p>
              </div>
            <% }) %>
          <% } %>

          <% if (user) { %>
            <form class="review-form" method="POST" action="/reviews/reply" style="margin-top:8px;">
              <input type="hidden" name="listing_id" value="<%= listing.id %>">
              <input type="hidden" name="parent_id" value="<%= r.id %>">
              <label>Reply
                <textarea name="comment" rows="2" required></textarea>
              </label>
              <button type="submit">Reply</button>
            </form>
          <% } %>
        </div>
      <% }) %>
    <% } else { %>
      <p>No reviews yet. Be the first to review.</p>
    <% } %>
  </section>
</section>

<!-- Lightbox modal with Prev / Next buttons -->
<div id="lightbox" class="lightbox" aria-hidden="true" style="display:none;">
  <button id="lightbox-close" class="lightbox-close" aria-label="Close">✕</button>
  <button id="lightbox-prev" class="lightbox-nav" aria-label="Previous image">‹</button>
  <img id="lightbox-img" src="" alt="large view">
  <button id="lightbox-next" class="lightbox-nav" aria-label="Next image">›</button>
</div>
