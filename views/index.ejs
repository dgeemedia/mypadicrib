<!-- views/index.ejs -->
<section class="container">
  <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
    <div>
      <h1 style="margin:0">mypadiCrib</h1>
      <p style="margin:4px 0;color:var(--muted)">Find shortlets across Nigerian states and LGAs</p>
    </div>
    <div>
      <a class="button" href="/listings">Browse all</a>
    </div>
  </header>

  <section>
    <h2>Featured listings</h2>

    <% if (listings && listings.length) { %>
      <div class="listing-grid">
        <% listings.forEach(function(l){ 
             const imgs = (l.images && l.images.length) ? l.images.map(i=>i.image_path) : (l.image_path ? [l.image_path] : []);
             const stats = l.reviewStats || {count:0, avg:0};
             const latest = l.latestReview || null;
        %>
<article class="card" data-images='<%= JSON.stringify(imgs) %>'>
  <div class="thumb">
    <a href="/listings/<%= l.id %>" aria-label="View <%= l.title %> details">
      <% if (imgs && imgs.length) { %>
        <img src="<%= imgs[0] %>" alt="thumb">
      <% } else { %>
        <div style="padding:12px;color:#888">No Image</div>
      <% } %>
    </a>
  </div>

  <div class="listing-meta">
    <h3>
      <a href="/listings/<%= l.id %>"><%= l.title %></a>
    </h3>
              <p style="color:var(--muted); font-size:14px"><%= l.description ? (l.description.length > 120 ? l.description.slice(0,120) + '…' : l.description) : '' %></p>
              <p style="margin-top:6px"><strong>Address:</strong> <%= l.address || '' %> — <%= l.state || '' %>, <%= l.lga || '' %></p>

              <div class="meta-row">
                <div class="rating-summary" title="<%= stats.avg %> average">
                  <div aria-hidden="true">
                    <% for (let i=1;i<=5;i++) { %>
                      <% if (i <= Math.round(stats.avg)) { %>
                        <span class="star filled small">★</span>
                      <% } else { %>
                        <span class="star small">☆</span>
                      <% } %>
                    <% } %>
                  </div>
                  <small>(<%= stats.count %>)</small>
                </div>

                <div style="margin-left:auto" class="price">&#8358;<%= l.price %> / night</div>
              </div>

              <% if (latest) { %>
                <div class="reviews-excerpt">
                  <small><strong><%= latest.name %></strong> — <%= latest.comment.length > 100 ? latest.comment.slice(0,100) + '…' : latest.comment %></small>
                </div>
              <% } %>

              <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                <% if (user) { %>
                  <% if (user.id !== l.owner_id) { %>
                    <form method="GET" action="/payments/checkout" style="margin-left:auto;">
                      <input type="hidden" name="listingId" value="<%= l.id %>">
                      <button type="submit">Book</button>
                    </form>
                  <% } else { %>
                    <span style="margin-left:auto;color:var(--muted)">Your listing</span>
                  <% } %>
                <% } else { %>
                  <a href="/auth/login" style="margin-left:auto" class="button">Login to book</a>
                <% } %>
              </div>
            </div>
          </article>
        <% }) %>
      </div>
    <% } else { %>
      <p>No listings yet.</p>
    <% } %>
  </section>
</section>
