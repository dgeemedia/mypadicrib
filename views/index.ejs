<!-- views/index.ejs -->
<section class="container">
  <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
    <div>
      <h1 style="margin:0">mypadiCrib</h1>
      <p style="margin:4px 0;color:var(--muted)">Find shortlets across Nigerian states and LGAs</p>
    </div>
    <div>
      <a class="button" href="/listings">Browse all</a>
    </div>
  </header>

  <section>
    <h2>Featured listings</h2>

    <% if (listings && listings.length) { %>
      <div class="listing-grid">
        <% listings.forEach(function(l){ 
             // ensure l.images is an array of image paths (controller can attach), fallback to [l.image_path]
             const imgs = (l.images && l.images.length) ? l.images.map(i=>i.image_path) : (l.image_path ? [l.image_path] : []);
        %>
          <article class="card" data-images='<%= JSON.stringify(imgs) %>'>
            <div class="thumb">
              <% if (imgs && imgs.length) { %>
                <img src="<%= imgs[0] %>" alt="thumb">
              <% } else { %>
                <div style="padding:12px;color:#888">No Image</div>
              <% } %>
            </div>

            <div class="listing-meta">
              <h3><a href="/listings/<%= l.id %>"><%= l.title %></a></h3>
              <p style="color:var(--muted); font-size:14px"><%= l.description ? (l.description.length > 120 ? l.description.slice(0,120) + '…' : l.description) : '' %></p>
              <p style="margin-top:6px"><strong>Address:</strong> <%= l.address || '' %> — <%= l.state || '' %>, <%= l.lga || '' %></p>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                <div class="price">&#8358;<%= l.price %> / night</div>
                <% if (user) { %>
                  <% if (user.id !== l.owner_id) { %>
                    <form method="GET" action="/payments/checkout" style="margin-left:auto;">
                      <input type="hidden" name="listingId" value="<%= l.id %>">
                      <button type="submit">Book</button>
                    </form>
                  <% } else { %>
                    <span style="margin-left:auto;color:var(--muted)">Your listing</span>
                  <% } %>
                <% } else { %>
                  <a href="/auth/login" style="margin-left:auto" class="button">Login to book</a>
                <% } %>
              </div>
            </div>
          </article>
        <% }) %>
      </div>
    <% } else { %>
      <p>No listings yet.</p>
    <% } %>
  </section>
</section>

